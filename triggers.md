принцип единого отражения на любой тригер

утверждение
  набор индексов обобщенный по listId описывает один путь от нода до корня
  у каждого нода всегда 1 или более наборов индексов

пути от нода до корня
  появляются новые

    ~ если target нод рут
      I = найти все target и дочерние наборы индексов где target имеет 0 глубину
      скопировать I
        столько раз, сколько у source наборов индексов
        сдвинуть глубину у каждого на столько сколько у source в сопоставленном наборе его глубина
      удалить I

    ~ если target не рут
      SL = найти все наборы в которых участвует source
      TL = найти любой набор в котором уже участвует target
      I = найти все наборы индексов начинающиеся с TL на все дочерние ноды
      скопировать I
        столько раз, сколько SL
        с заменой начала набора TL на SL
          получить все дочерние индексы от I глубина которых больше или равна глубине target в TL (те индексы что останутся при копировании)
            отнять от каждого глубину target в TL (но -1), затем прибавить глубину source в SL

      (пример 1
        5 всего наборов у ребенка X
        2 набора начинающиеся с TL у ребенка X
        3 набора у source
        3 * 2 = 6 добавочных наборов
      )
      (пример 2
        1 всего наборов у ребенка X
        1 набора начинающиеся с TL у ребенка X
        2 набора у source
        2 * 1 = 2 добавочных наборов
      )
      (пример 3
        1 всего наборов у ребенка X
        1 набора начинающиеся с TL у ребенка X
        1 набора у source
        1 * 1 = 1 добавочных наборов
      )
  удаляются старые